<!-- Keep the original structure but fix the visibility -->
<header class="topbar">
    <div class="stars"></div>
    <div class="cosmic-element cosmic-element--1"></div>
    <div class="cosmic-element cosmic-element--2"></div>

    <div class="sonic-container topbar__row">
        <button class="burger" type="button" (click)="toggleMobile()" aria-label="Open menu"
            [attr.aria-expanded]="mobileOpen()">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>

        <a class="brand" routerLink="/">Sonic</a>

        <nav class="nav desktop nav-spotlight-group">
            <div class="spotlight-overlay"></div>

            @for (link of navLinks; track link.label) {
            <a class="nav__link" [routerLink]="link.path" routerLinkActive="active"
                [routerLinkActiveOptions]="{ exact: !!link.exact }">
                {{ link.label }}
            </a>
            }
        </nav>

        <div class="spacer"></div>

        <div class="auth desktop">
            @if (!isAuthenticated()) {
            <a class="btn btn--ghost" routerLink="/account/login">Log In</a>
            <a class="btn btn--solid" routerLink="/account/register">Sign Up</a>
            } @else {
            <a class="btn btn--create" routerLink="/posts/new">
                <span class="plus">+</span> Create
            </a>

            <a class="profile-chip" routerLink="/profile" aria-label="Profile">
                @if (avatarUrl()) {
                <img class="profile-chip__img" [src]="avatarUrl()" alt="Avatar" />
                } @else {
                <div class="profile-chip__fallback">{{ initial() }}</div>
                }
                <span class="profile-chip__text">{{ displayName() || 'Profile' }}</span>
            </a>

            <button class="icon-btn" (click)="logout()" title="Logout">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
            }
        </div>
    </div>

    <!-- Drawer should stay inside for data binding -->
    <div class="drawer" [class.drawer--open]="mobileOpen()">
        <div class="drawer__backdrop" (click)="closeMobile()"></div>

        <aside class="drawer__panel" role="dialog" aria-modal="true" aria-label="Navigation">
            <div class="drawer__header">
                <a class="brand" routerLink="/" (click)="closeMobile()">Sonic</a>
                <button class="icon-btn" type="button" (click)="closeMobile()" aria-label="Close menu">âœ•</button>
            </div>

            <nav class="drawer__nav">
                @for (link of navLinks; track link.label; let i = $index) {
                <a class="drawer__link" [routerLink]="link.path" routerLinkActive="active"
                    [routerLinkActiveOptions]="{ exact: !!link.exact }" (click)="closeMobile()" [style.--i]="i">
                    <span>{{ link.label }}</span>
                </a>
                }
            </nav>

            <div class="drawer__footer">
                @if (!isAuthenticated()) {
                <div class="drawer__actions">
                    <a class="btn btn--ghost btn--block" routerLink="/account/login" (click)="closeMobile()">Log In</a>
                    <a class="btn btn--solid btn--block" routerLink="/account/register" (click)="closeMobile()">Sign
                        Up</a>
                </div>
                } @else {
                <div class="drawer__user" routerLink="/profile" (click)="closeMobile()">
                    @if (avatarUrl()) {
                    <img class="drawer-avatar" [src]="avatarUrl()" alt="Avatar" />
                    } @else {
                    <div class="drawer-avatar__fallback">{{ initial() }}</div>
                    }
                    <div class="drawer-user-info">
                        <span class="drawer-name">{{ displayName() || 'Profile' }}</span>
                        <span class="drawer-role">Member</span>
                    </div>
                </div>

                <div class="drawer__actions">
                    <a class="btn btn--create btn--block" routerLink="/posts/new" (click)="closeMobile()">+ New Post</a>
                    <button class="btn btn--ghost btn--block" (click)="logout(); closeMobile()">Logout</button>
                </div>
                }
            </div>
        </aside>
    </div>
</header>

<main class="main">
    <div class="grid-overlay"></div>

    <div class="sonic-container">
        <router-outlet />
    </div>
</main>