<section class="pf">
    <div class="pf__wrap">

        <header class="pf__header">
            <h1 class="pf__title">Dashboard</h1>
            <p class="pf__subtitle">Manage and update your public credentials.</p>
        </header>

        @if (loading()) {
        <div class="pf__card pf__card--loading">
            <div class="spinner"></div>
            <p>Retrieving personnel file...</p>
        </div>
        }
        @else if (error()) {
        <div class="pf__alert">
            <div class="icon">‚ö†</div>
            <div class="content">
                <strong>System Error:</strong> {{ error() }}
                @if (errorCode()) { <span class="code">Code: {{ errorCode() }}</span> }
            </div>
        </div>
        }
        @else {
        <form class="pf__card" [formGroup]="form" (ngSubmit)="save()">

            <div class="form-section">
                <h3 class="section-title">Visual Identity</h3>

                <div class="avatar-row">
                    <div class="avatar-preview">
                        @if (form.get('avatarUrl')?.value) {
                        <img [src]="form.get('avatarUrl')?.value" alt="Preview"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" />
                        <div class="avatar-fallback" style="display: none">{{ form.get('displayName')?.value?.slice(0,1)
                            || '?' }}</div>
                        } @else {
                        <div class="avatar-fallback">{{ form.get('displayName')?.value?.slice(0,1) || '?' }}</div>
                        }
                    </div>

                    <div class="field field--grow">
                        <label class="label"><span class="icon">üñº</span> Avatar Uplink (URL)</label>
                        <input class="input" formControlName="avatarUrl" placeholder="https://..." />
                        @if (avatarUrlError()) {
                        <p class="field-error">{{ avatarUrlError() }}</p>
                        }
                    </div>
                </div>

                <div class="field">
                    <label class="label"><span class="icon">üë§</span> Display Name</label>
                    <input class="input" formControlName="displayName" placeholder="Agent Name" />
                    @if (displayNameError()) {
                    <p class="field-error">{{ displayNameError() }}</p>
                    }
                </div>
            </div>

            <div class="divider"></div>

            <div class="form-section">
                <h3 class="section-title">Professional Data</h3>

                <div class="field">
                    <label class="label"><span class="icon">üíº</span> Designation / Role</label>
                    <input class="input" formControlName="jobRole" placeholder="e.g. Senior Architect" />
                </div>

                <div class="field">
                    <label class="label"><span class="icon">üìù</span> Bio / Dossier</label>
                    <textarea class="input input--textarea" rows="4" formControlName="bio"
                        placeholder="Brief operational history..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <label class="label"><span class="icon">‚ö°</span> Specializations (Interests)</label>

                <div class="tag-input-group">
                    <input class="input" [value]="interestDraft()"
                        (input)="interestDraft.set(($any($event.target)).value)"
                        (keydown.enter)="$event.preventDefault(); addInterestFromDraft()"
                        placeholder="Add specialization..." />
                    <button class="btn btn--ghost" type="button" (click)="addInterestFromDraft()">Add</button>
                </div>

                @if (interestDraft().includes(',')) {
                <p class="hint hint--warn">One item at a time.</p>
                }

                <div class="tag-area">
                    @if (interests().length > 0) {
                    <div class="tag-list">
                        @for (x of interests(); track x) {
                        <button class="tag-chip" type="button" (click)="removeInterest(x)" title="Remove">
                            {{ x }} <span class="x">‚úï</span>
                        </button>
                        }
                    </div>
                    } @else {
                    <p class="muted-text">No specializations recorded.</p>
                    }
                </div>
            </div>

            <footer class="pf__footer">
                <button class="btn btn--ghost" type="button" (click)="cancel()" [disabled]="saving()">
                    Cancel
                </button>
                <button class="btn btn--solid" type="submit" [disabled]="!canSubmit()">
                    @if (saving()) {
                    <span class="spinner-sm"></span> Saving...
                    } @else {
                    Update Profile
                    }
                </button>
            </footer>
        </form>
        }
    </div>
</section>