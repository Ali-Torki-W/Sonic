<section class="feed">
    <header class="feed__header">
        <h1>Explore</h1>

        <div class="feed__filters">
            <input type="text" placeholder="Search posts (title/body)..." [value]="q()"
                (input)="q.set(($any($event.target)).value)" (keydown.enter)="onSearchEnter()" />

            <button type="button" (click)="toggleFeatured()">
                @if (featuredOnly()) { Featured: ON } @else { Featured: OFF }
            </button>

            <button type="button" (click)="clearFilters()">Clear</button>
        </div>

        <div class="feed__types">
            <button type="button" (click)="setType(null)">All</button>
            @for (t of typeOptions; track t) {
            <button type="button" (click)="setType(t)">
                {{ t }}
            </button>
            }
        </div>

        <div class="feed__tags">
            <input type="text" placeholder="Add tag (one-by-one)" [value]="tagDraft()"
                (input)="tagDraft.set(($any($event.target)).value)" (keydown.enter)="addTagFromDraft()" />
            <button type="button" (click)="addTagFromDraft()">Add</button>

            @if (selectedTags().length > 0) {
            <div class="feed__taglist">
                @for (tag of selectedTags(); track tag) {
                <button type="button" (click)="removeTag(tag)">#{{ tag }} ✕</button>
                }
            </div>
            }
        </div>
    </header>

    @if (error()) {
    <div class="feed__error">
        <p><strong>Error:</strong> {{ error() }}</p>
        @if (errorCode()) {
        <p><small>code: {{ errorCode() }}</small></p>
        }
    </div>
    }

    @if (loading() && items().length === 0) {
    <p>Loading...</p>
    } @else if (items().length === 0) {
    <p>No posts found.</p>
    } @else {
    <div class="feed__list">
        @for (p of items(); track p.id) {
        <article class="post">
            <h3>
                <a [routerLink]="['/posts', p.id]">{{ p.title }}</a>
            </h3>

            <p class="post__meta">
                <span>{{ p.type }}</span>
                <span> · </span>
                <span>by {{ authorName(p.authorId) }}</span>
                <span> · </span>
                <span>{{ p.createdAt | date:'medium' }}</span>
            </p>

            <p class="post__body">{{ p.body }}</p>

            @if (p.tags.length > 0) {
            <p class="post__tags">
                @for (t of p.tags; track t) {
                <span>#{{ t }} </span>
                }
            </p>
            }

            <p class="post__stats">
                <span>Likes: {{ p.likeCount }}</span>
                @if (p.type === 'Campaign') {
                <span> · </span>
                <span>Participants: {{ p.participantsCount }}</span>
                }
            </p>
        </article>
        }
    </div>

    @if (canLoadMore()) {
    <button type="button" (click)="loadMore()" [disabled]="loading()">
        @if (loading()) { Loading... } @else { Load more }
    </button>
    }
    }
</section>