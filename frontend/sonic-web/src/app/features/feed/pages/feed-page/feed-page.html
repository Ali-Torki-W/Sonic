<section class="feed">
    <header class="feed__header">
        <h1>Explore</h1>

        <div class="feed__filters">
            <input type="text" placeholder="Search posts..." [ngModel]="q()" (ngModelChange)="q.set($event)"
                (keydown.enter)="onSearchEnter()" />

            <div class="feed__filter-buttons">
                <button type="button" [class.active]="featuredOnly()" (click)="toggleFeatured()">
                    @if (featuredOnly()) { Featured: ON } @else { Featured: OFF }
                </button>

                <button type="button" (click)="clearFilters()">Clear</button>
            </div>
        </div>

        <div class="feed__types">
            <button type="button" [class.active]="selectedType() === null" (click)="setType(null)">All</button>

            @for (t of typeOptions; track t) {
            <button type="button" [class.active]="selectedType() === t" (click)="setType(t)">
                {{ t }}
            </button>
            }
        </div>

        <div class="feed__tags">
            <input type="text" placeholder="Add tag" [ngModel]="tagDraft()" (ngModelChange)="tagDraft.set($event)"
                (keydown.enter)="addTagFromDraft()" />
            <button type="button" (click)="addTagFromDraft()">Add</button>

            @if (selectedTags().length > 0) {
            <div class="feed__taglist">
                @for (tag of selectedTags(); track tag) {
                <button type="button" (click)="removeTag(tag)">#{{ tag }} âœ•</button>
                }
            </div>
            }
        </div>
    </header>

    @if (error()) {
    <div class="feed__error">
        <p><strong>Error:</strong> {{ error() }}</p>
    </div>
    }

    @if (loading() && items().length === 0) {
    <p>Loading...</p>
    }
    @else if (items().length === 0) {
    <p>No posts found.</p>
    }
    @else {
    <div class="feed__list">
        @for (p of items(); track p.id) {
        <article class="post">

            @if (p.authorId === meId() || meRole() === 'Admin') {
            <button type="button" class="post__delete-btn" (click)="deletePost($event, p)" title="Delete Post">
                âœ•
            </button>
            }

            <h3>
                <a [routerLink]="['/posts', p.id]">{{ p.title }}</a>
            </h3>

            <p class="post__meta">
                <span>{{ p.type }}</span>
                <span> Â· </span>
                <span class="author-name">{{ getAuthorName(p.authorId) }}</span>
                <span> Â· </span>
                <span>{{ p.createdAt | date:'medium' }}</span>
            </p>

            <p class="post__body">{{ p.body }}</p>

            @if (p.tags.length > 0) {
            <p class="post__tags">
                @for (t of p.tags; track t) {
                <span>#{{ t }} </span>
                }
            </p>
            }

            <p class="post__stats">
                <span>â™¥ {{ p.likeCount }}</span>
                @if (p.type === 'Campaign') {
                <span> Â· </span>
                <span>ðŸ‘¤ {{ p.participantsCount }}</span>
                }
            </p>
        </article>
        }
    </div>

    @if (canLoadMore()) {
    <button type="button" class="load-more" (click)="loadMore()" [disabled]="loading()">
        @if (loading()) { Loading... } @else { Load more }
    </button>
    }
    }
</section>