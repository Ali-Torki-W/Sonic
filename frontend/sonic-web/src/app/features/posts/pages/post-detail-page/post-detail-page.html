<section class="pd">
    <div class="pd__wrap">

        <header class="pd__topbar">
            <a class="pd__back" routerLink="/feed">
                <span class="icon">‚Üê</span> Back to Feed
            </a>
        </header>

        @if (postLoading()) {
        <div class="pd__card pd__card--loading">
            <div class="spinner"></div>
            <p>Decrypting signal...</p>
        </div>
        }
        @else if (postError()) {
        <div class="pd__card pd__card--error">
            <div class="error-icon">‚ö†</div>
            <div class="error-content">
                <h3>Transmission Error</h3>
                <p>{{ postError() }}</p>
                <a routerLink="/feed" class="btn btn--ghost">Return to Command</a>
            </div>
        </div>
        }
        @else if (post(); as p) {

        <article class="pd__card post-card">

            <header class="post-card__header">
                <div class="header-top">
                    <span class="type-badge">{{ p.type }}</span>
                    <span class="date">{{ p.createdAt | date:'mediumDate' }}</span>
                </div>

                <h1 class="post-title">{{ p.title }}</h1>

                <div class="author-row">
                    <div class="author-avatar">{{ p.authorId.slice(0,1) }}</div>
                    <div class="author-info">
                        <span class="name">{{ getAuthorName(p.authorId) }}</span>
                        <span class="role">Author</span>
                    </div>
                </div>
            </header>

            <div class="post-content">
                {{ p.body }}
            </div>

            @if (p.externalLink) {
            <a [href]="p.externalLink" target="_blank" rel="noopener" class="external-link-card">
                <div class="icon">üîó</div>
                <div class="text">
                    <span class="label">External Uplink</span>
                    <span class="url">{{ p.externalLink }}</span>
                </div>
                <div class="arrow">‚Üó</div>
            </a>
            }

            @if (p.tags.length) {
            <div class="post-tags">
                @for (t of p.tags; track t) {
                <span class="tag">#{{ t }}</span>
                }
            </div>
            }

            @if (isCampaign()) {
            <section class="campaign-module">
                <div class="module-header">
                    <span class="icon">üéØ</span> Mission Objective
                </div>

                <div class="module-grid">
                    <div class="stat">
                        <span class="label">Goal</span>
                        <span class="value">{{ p.campaignGoal }}</span>
                    </div>
                    <div class="stat">
                        <span class="label">Active Agents</span>
                        <span class="value">{{ p.participantsCount }}</span>
                    </div>
                </div>

                <div class="module-actions">
                    @if (!isAuthed()) {
                    <button class="btn btn--solid" (click)="goToLogin()">Login to Join</button>
                    } @else {
                    <button class="btn" [class.btn--solid]="!joinedCampaign()" [class.btn--ghost]="joinedCampaign()"
                        (click)="joinCampaign()" [disabled]="joinBusy() || joinedCampaign()">
                        @if (joinBusy()) { Processing... }
                        @else if (joinedCampaign()) { ‚úì Joined Mission }
                        @else { Join Mission }
                    </button>
                    }

                    @if (joinToast()) {
                    <span class="module-status">{{ joinToast() }}</span>
                    }
                </div>
            </section>
            }

            <footer class="post-actions">
                <button class="action-btn" [class.active]="liked()" (click)="toggleLike()" [disabled]="likeBusy()">
                    <span class="icon">‚ô•</span>
                    <span>{{ liked() ? 'Liked' : 'Like' }}</span>
                    <span class="count">{{ p.likeCount }}</span>
                </button>

                @if (canEditPost()) {
                <button class="action-btn" (click)="goToEdit()">
                    <span class="icon">‚úé</span> Edit Post
                </button>

                <button class="action-btn" style="color: #ef4444; border-color: rgba(239, 68, 68, 0.4);"
                    (click)="deletePost()">
                    <span class="icon">üóë</span> Delete
                </button>
                }
            </footer>
        </article>

        <section class="pd__comments">
            <header class="comments-header">
                <h2>Comms Log</h2>
                <span class="badge">{{ commentsTotalItems() }}</span>
            </header>

            <div class="comment-box">
                <textarea [(ngModel)]="commentDraft" placeholder="Transmit a response..." rows="3"></textarea>
                <div class="controls">
                    <button class="btn btn--solid btn--sm" (click)="submitComment()"
                        [disabled]="creatingComment() || !commentDraft().trim()">
                        {{ creatingComment() ? 'Sending...' : 'Send' }}
                    </button>
                </div>
            </div>

            @if (commentsLoading() && commentItems().length === 0) {
            <div class="comments-loading">Retrieving logs...</div>
            }
            @else if (commentItems().length === 0) {
            <div class="comments-empty">No transmissions found.</div>
            }
            @else {
            <div class="comments-feed">
                @for (c of commentItems(); track c.id) {
                <div class="comment-entry">
                    <div class="avatar">{{ getAuthorName(c.authorId).slice(0, 1) }}</div>
                    <div class="content">
                        <div class="meta">
                            <span class="name">{{ getAuthorName(c.authorId) }}</span>
                            <span class="time">{{ c.createdAt | date:'short' }}</span>
                        </div>
                        <div class="text">{{ c.body }}</div>
                        @if (c.authorId === meId() || meRole() === 'Admin') {
                        <button class="delete-btn" (click)="deleteComment(c.id)">Delete</button>
                        }
                    </div>
                </div>
                }
            </div>

            @if (canLoadMoreComments()) {
            <button class="btn btn--ghost load-more" (click)="loadMoreComments()" [disabled]="commentsLoading()">
                Load Earlier Logs
            </button>
            }
            }
        </section>
        }
    </div>
</section>